<!DOCTYPE html>
<html>
  <head>
    <title>OSC Bridge Server</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
        text-align: center;
        background: #f0f2f5;
      }
      .info {
        margin: 20px;
        padding: 15px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px;
      }
      .status-box {
        background: #ffffff;
        padding: 15px;
        border-radius: 8px;
        text-align: left;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .message-log {
        margin: 20px;
        padding: 15px;
        background: #ffffff;
        border-radius: 8px;
        text-align: left;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
      }
      .message {
        font-family: monospace;
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid #eee;
        word-break: break-all;
      }
      .websocket {
        border-left: 4px solid #4caf50;
      }
      .udp {
        border-left: 4px solid #2196f3;
      }
      code {
        background: #f5f5f5;
        padding: 5px;
        border-radius: 4px;
      }
      .heartbeat-controls {
        margin: 20px;
        padding: 15px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .heartbeat-controls input[type="number"] {
        width: 100px;
        padding: 5px;
        margin: 0 10px;
      }
      .heartbeat-controls button {
        padding: 8px 16px;
        margin: 0 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: #4caf50;
        color: white;
      }
      .heartbeat-controls button.off {
        background: #f44336;
      }
    </style>
  </head>
  <body>
    <h2>OSC Bridge Server</h2>

    <div class="heartbeat-controls">
      <h3>Heartbeat Controls</h3>
      <div>
        <input type="number" id="heartbeat-delay" value="5000" min="100" step="100" />
        <label for="heartbeat-delay">ms</label>
        <button id="heartbeat-toggle">Stop Heartbeat</button>
      </div>
    </div>

    <div class="status-container">
      <div class="status-box">
        <h3>WebSocket OSC (p5.js)</h3>
        <p>Status: <span id="ws-status">Initializing...</span></p>
        <p>URL: <code>ws://localhost:8080</code></p>
        <p>Connected Clients: <span id="ws-clients">0</span></p>
      </div>

      <div class="status-box">
        <h3>UDP OSC (TouchOSC)</h3>
        <p>Server: <code id="udp-server">Fetching...</code></p>
        <p>Client: <code>Port: 9000</code></p>
      </div>
    </div>

    <div class="message-log">
      <h3>Message Log</h3>
      <div id="message-container"></div>
    </div>

    <script>
      // Get IP address
      async function fetchServerIP() {
        try {
          const networks = await require("os").networkInterfaces();
          const ip =
            Object.values(networks)
              .flat()
              .find((n) => !n.internal && n.family === "IPv4")?.address || "127.0.0.1";
          document.getElementById("udp-server").innerText = `${ip}:12000`;
        } catch (error) {
          console.error("Error getting IP:", error);
        }
      }
      fetchServerIP();

      // Handle OSC status updates
      const { ipcRenderer } = require("electron");

      // Heartbeat controls
      const heartbeatToggle = document.getElementById("heartbeat-toggle");
      const heartbeatDelay = document.getElementById("heartbeat-delay");
      let heartbeatEnabled = true;

      function updateHeartbeatControls(enabled, delay) {
        heartbeatEnabled = enabled;
        heartbeatToggle.textContent = enabled ? "Stop Heartbeat" : "Start Heartbeat";
        heartbeatToggle.className = enabled ? "" : "off";
        if (delay) heartbeatDelay.value = delay;
      }

      heartbeatToggle.addEventListener("click", () => {
        const newState = !heartbeatEnabled;
        ipcRenderer.send("heartbeat-control", {
          enabled: newState,
          delay: parseInt(heartbeatDelay.value),
        });
      });

      heartbeatDelay.addEventListener("change", () => {
        if (heartbeatEnabled) {
          ipcRenderer.send("heartbeat-control", {
            enabled: true,
            delay: parseInt(heartbeatDelay.value),
          });
        }
      });

      // Handle heartbeat status updates
      ipcRenderer.on("heartbeat-status", (event, { enabled, delay }) => {
        updateHeartbeatControls(enabled, delay);
      });

      // Update WebSocket status
      ipcRenderer.on("ws-status", (event, data) => {
        document.getElementById("ws-status").innerText = data.status;
        document.getElementById("ws-clients").innerText = data.clients || 0;
      });

      // Log messages
      function addMessage(type, content) {
        const container = document.getElementById("message-container");
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${type}`;
        const timestamp = new Date().toLocaleTimeString();
        msgDiv.innerHTML = `[${timestamp}] ${content}`;
        container.insertBefore(msgDiv, container.firstChild);

        // Keep only last 50 messages
        if (container.children.length > 50) {
          container.removeChild(container.lastChild);
        }
      }

      // Handle incoming OSC messages
      ipcRenderer.on("osc-message", (event, data) => {
        const messageType = data.type || "udp";
        addMessage(messageType, `${JSON.stringify(data.message)} from ${data.from}`);
      });

      // Handle WebSocket client connections
      ipcRenderer.on("ws-client", (event, data) => {
        addMessage("websocket", `Client ${data.event}: ${data.id}`);
      });
    </script>
  </body>
</html>
